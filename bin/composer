#! /bin/bash

#
#
#                                                       .###@          ###
#                                                       ##++##@       '#+#'
#                                                      ####+++##@      #++#
#                                                      ##+###+++##;    #++#@
#                                                      ##+++##++++##   .#++#.
#                                                      `##+++###++++#,  #+++#
#                               '                       `##++++##++++#@ '#++#'
#                             ###`            ,#          ##++++##++++## #+++#
#                           ##++#            @#      ###:  ##++++##++++###+++##
#                        .@#+++#           '##      ##+##@  ##+++++#++++###+++#
#     #:         :##  .@##++++#           ##        `##++##: ##+++++#++####+++#'
#    .##         ######++++++#          @#'           ##+++#@ ##+++++#++++#++++#
#     #+#       #+++#++++++#@         ,##              @#+++####+++++++++++++++#
#     #+#,     @#+++##++++##`        @#;                '#++++###++++++++++++++##
#     #++#    `#+++++##+##+##      +#@                   ,#++++###++++++++++++++#
#     @++#+   ##++++++###+++#     ###,                    .#+++++##+++++++++++++#
#     :#++#  +#++++++++##+++#   @###+#@                    .#+++++++++++++++++++#`
#      #+++@ #+++++#++++##+++#,####+++#                     .#+++++++++++++++++++'
#      #+++###++++###++++#+++####++++##                      '#++++++++++++++++++@
#      #++++#+++++#+##++++#####+++++##                      ``##+###+++++++++++++#
#      `#+++#+++++++++##++###++++++##                  .##########+++++++++++++++#
#       #++++#+++++++++#####+++++++#                  ###++++++++++++++++++++++++#
#       @++++#++++++++###+++++++++#                  ,#++++++++++++++++++++++++++#
#       :#++++++++++###++++++++++#:                   @##++++++++++++++++++++++++#
#        #++++++++####++++++++++##                       +###++++++++++++++++++++#
#        #+++++++###++++++++++++#                           @##+++++++++++++++++#@
#        ;#++++###+++++++++++++#@                             @#++++++++++++++++##
#         #++####++++++++++++++#                               @#++++++++++++++++#.
#         #####+++++++++++++++##                                .##++++++++++++++#@
#        ;####++++++++++++++++#                                   +####+++++++++++#
#        ###+++++++++++++++++#@                                     ,@##++++++++++#;
#         ,@#+++++++++++++++##                                         ##+++++++++##
#          `#++++++++++++++###                                         +##+++++++++#       `@
#           ##+++++++++++####                                            ##++++++++#@   .@##@
#           ;#++++++++++##@                                              +#+++++++++#;@#####@
#            ##+++++++++#                                                 #+++++++######';;+#
#            ##+++++++++#                                                 ##++#######;;;;+;#'
#            #+++++++++#:                                                 @######+;;;;;;####,
#           +#+++++++++@                                               `######';;;;;;;;;##;#`
#      #+   @+++++++++#;                                            ,@####+;;;;;;;;;;;;;;;;#
#      ####@#+++++++++#                   #@######@:                ###';;;;;;;;;;;;;;;;;;;#
#      #;;;'#####+++++#                 @############@               ##;;;;;;;;;;;;;;;;;;;+#
#      #;;;;;;;+######@               @################:             '#;;;;;;;;;;;;;;;;+##:
#     `#;;+#;;;;;;;+###@'           ####################@             ##;;;;;;;;;;;;'####@
#     .#;;###;;;;;;;;;;####@'      #######################            ,#';;;;;;;;'###+;';##
#     ;#;'###;;;;;;;;;;;;;'##     ########################.+@@@#.      ##;;;;;'####::::::'#:
#     ##;;##';;;;;;;;;;;;;;'#    #################################;    `#+;;####';+'';;';'+#
#     @#;;;;;;;;;;;;;;;;;;;#`   ################################`###    @####'::':;::::;:;##
#     @#+';;;;;;;;;;;;;;;;;#   ################################### ##`   #'##:::':;::::':;##
#     @@#######+';;;;;;;;;;#  ##################################### @#    `#+:::':;::::':;;#
#        :#++#########+';;## @#'#################################### ##   ##::::':;::::#+;:#
#        ##';';':;'+#######..#.###################################### #@ ##';;';';';;;;'####
#        ##;:'::::;:'::+#`, ##########################################:#' ##::::':;::::;:'##
#        ##''+;'''''''''#  ##,#####################################+##### '#''''+;+''';'+''#`
#        ##':;::::;:':;:#, # #######################################'@#### ##:::':;::::;:;:##
#         ##:'::::;:':;:####,######################################### ### ##:;:':;::::':':#:
#         @#;'::::;:':::### ########################################### ####':::':;::::;:;;#
#         ##:;::::::':::###.############################################+###':::;:;::::;:;##
#         ##;';;;:;:+;':+#############################################+#####;:;:';';;;;';'#;
#         ##:;::::;:':;:;###############################################@##+::::':;::::':##
#         ##''''''''''+''###############################################`@##'''''''''''''##
#         ##:'::::;:':;:################################################# ##':::;:;:::::'#
#         @#:':;::;:':;+##################################################:#+::;':;::::;#@
#         @#:'::::::'::##################################+################:##:::':;::::+#.
#         @#:'::::::':'##################################+###################;::':;::::##
#         @#:':;::;:';##################################+++##################;;:':;::::##
#         @#:;::::::''############################+####+++++###################'':;:::;#
#         @#;''+'''''###########################++####+++++++####################'''''##
#         @#:'::::::'########################++++##++++++++++++###################':::##
#         ##;':;;:';+##'##########++++++++++++++++#++#++++++++++############++#####';:#`
#         +#:;::::::##+;########+++++++++++++++++##++#+++++++++++############:::;:;#;:#
#         '#;'::::;:##:;######++++++++#####++++++##++#++++++++++++++##########;:':;::+#
#         ;#:':::::'#:;:####+++++++++#############++++####+++++++#+++++########;':;::##
#         :#:':::::'#:::####+##+++++++++++++#####++++++##########+++++++#+######':;::##
#         ,#;'''';'+''';####+##+++++++++++++++++#++++++++#+##+++++#+++++#+##'+##+;';'#`
#         :#:'::::;#;:::#####+#++++++##########+##+++++++##+++++##+++++#++##'::##;;::#
#         '#;';#;;;;+;''#####++#++++++++####++++##+++++++++#####+++++++++###';;;#'';'#
#         +##+#;::;:':;:;#####+++++++++++++++++++#++++++++++++++++++++++####::;:#+':'#
#          ;###:::;:':;::+#####++++++++++++++++++#+++++++++++++++++++#######::::'#;:#@
#             #:::;:':;:::+#:###++++++++++++++++##++++##+++++++++++++#######::;:'#;:#+
#             ##::;:'::::::'+;;###++++++++++++++##+++#++++++++++++++#####+##::;:':;'#
#             ###'';''';'';';+;;###+++++++++++++###+##+++++++++++++##'###'##;;''+;'##
#              `##;:':;::::':;::'##++++++++++++++####+++++++++++++##':###'##::::':'#.
#                @##';';'';+;';;'###++++++++++++++##++++#+++++++###++;+##'##;;';';##
#                 +##::::::':;:::#####+++++++######+#####++++++#++#'::;##'+#;:::''##
#                  `##+::::':;:::###+##+++++###+++###++++++++++++##;:::##':#':::''#:
#                    @##:::':;:::##'+:###++++++++++++++++++++++++#+::::##'::':::''#.
#                     '##::':;::'#+:'::+##++++++#######+++++++++##'::::;#'::::::;'#`   .
#                       ##+';';;##';';;;##+++++###+++++#++++++++#+';;;;'#';;;;';''##@#'
#                        @##:;::#:;:;:::;##++++#+++++++++++++++##+'::::;:+::::::'##'#,
#                         :##'''';+'';''####+++#+++++++++++++++###';''''''''';+##. ',
#                           ##::::;:;::'#+;##++#++++++++++++++##+#'::::;:;::##@    ;    `
#                          ;#+::::':'::+#;;;#+++++++++++++++###;;#+::::;:'##'     + ,@@
#                          ##+::::;:':;;#;;;'#+++++++++++++###;;;##::::'##.      .@##`
#              `##+;,`      .#::::':;:;:#';;;;##++++++++#####;;;;;#::+##`      @####
#                @#   .+##@'`#:;;:';+:;:#;;;;;;+###########;;;;;;;####`     ,###### '@'
#                  @;      +####+:;:;:'#';;;;'######+++######+;;;###`     '########`
#                   `@        `@####+'#+;;;;##+';;+#####+;;+####;##     ######@,
#                     `           '@####;;;;;;;'###@;#+.###+;;;#;+@   @####@`
#                                    +##;;;;;'###:        @###';;## @###@`
#                .;#@#############@#',##;;;;##+            ##########@,
#                            `,:+@######;;##@##+          #@   #####
#                                    ;@#####'  @#@`     :#@   `##:
#                                         ;@###@####`  ##@   @#:
#                               ,             `+@####@@#@  :#+                     ;'
#                    @##@    ####@          ;    ######+ :####    @##     ,'';: +#####
#                   ###@#   ##@###`   #@   ##.  ;#+`##' #######  ##@#@   #####@ ##; ##
#                  ##      @#   ##.  ##@  @##.  #@  ##`,#;  `#@ ##   .  #+      ##  ##
#                 @#      `#:   '#  #### +###   #` :#@ #@    #' .#:    ##      ;#  ##:
#                 #@      @#    @#  ###'`#+##  +# @#@ :#    :#   @#    ######  @#;##'
#                '#.      #@    #' ####+## ##  ###@   @#    ##`.  ##   ##@@#   #####
#                @#` ,##, #'   @# +#,@###  #@  ##     ##   ;# ##  `#@ '#`      #@ @##
#                ######+  ##  @#  #@ ###   ## ;#:     ##  ;#: :##. ## @###### ;#;  ###
#                '###'    #####  ##  @#    ##'@#      @####`    ##### ####@@; @#`   ###'
#                 `       .@@`  @#         ;:  `       @@:        .,  ,       ,:     @#
#                               `.
#
# pic generated using picascii.com

# TODO: write a windows version of this perhaps?

# set strict mode
set -euo pipefail


# kanged from http://stackoverflow.com/a/246128
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"


if [ ! -e ${DIR}/composer.phar ]; then
  # php -r "readfile('https://getcomposer.org/installer');" > composer-setup.php
  curl --silent https://getcomposer.org/installer > composer-setup.php

  hash=$( curl --silent https://composer.github.io/pubkeys.html | grep -C1 "Installer Signature (SHA-384)" | grep '<pre>\([a-z0-9]\+\)</pre>' | sed s/\<pre\>// | sed s/\<\\/pre\>// )

  # filehash=$( php -r "if (hash('SHA384', file_get_contents('composer-setup.php')) === '"${hash}"') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;" )
  filehash=$( sha384sum composer-setup.php | cut -d' ' -f1 )

  if [ "$hash" == "$filehash" ]; then
    echo "installer verified"
  else
    echo "installer corrupt"
    exit
  fi

  php composer-setup.php --install-dir=bin

  # php -r "unlink('composer-setup.php');"
  rm composer-setup.php
fi

# a couple of newlines here
echo -e "\n\n"

php bin/composer.phar $*
